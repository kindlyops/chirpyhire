$(document).on("page:change", function() {
  $(".user").on("click", ".send-message, .cancel-message", function(e) {
    if($("form.new_message").length) {
      e.stopPropagation();
      e.preventDefault();
      $("form.new_message").remove();
      $('.main-content-wrapper').css('height', 'calc(100% - 150px)')
    }
  });

  if ($('.user section.timeline').length) {
    setInterval(function() {
      $.get("/users/" + $('.user').data('id') + "/messages").then(function(data) {
        $('section.timeline').html(data);
      });
    }, 3000);
  }

  mapboxgl.accessToken = <%= ENV['MAPBOX_TOKEN'] %>;
  var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v9',
      center: [$('#map').data('long'), $('#map').data('lat')],
      zoom: 14
  });
  map.on('load', function() {
    map.addSource("symbols", {
        "type": "geojson",
        "data": {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {},
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            $('#map').data('long'),
                            $('#map').data('lat')

                        ]
                    }
                }
            ]
        }
    });
    map.addLayer({
        "id": "symbols",
        "type": "symbol",
        "source": "symbols",
        "layout": {
            "icon-image": "circle-stroked-11"
        }
    });
  });

  $(".user").on("change", "select#candidate_status", function(e) {
    var editCandidateForm = $("form.edit_candidate");
    $.ajax({
      url: editCandidateForm.attr("action"),
      data: editCandidateForm.serialize(),
      method: 'PUT',
      dataType: 'html'
    }).done(function(data) {
      var authToken = $(data).find("input[name='authenticity_token']");
      $("form.edit_user input[name='authenticity_token']").replaceWith(authToken);
    });
  });
});
