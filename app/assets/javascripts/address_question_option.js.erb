$(document).on("turbolinks:load", function() {
  var map;
  var defaultDistance = 10;

  function initMap() {
    mapboxgl.accessToken = mapboxgl.accessToken || '<%= ENV.fetch("MAPBOX_PUBLIC_KEY") %>';
    var isDragging, isCursorOverPoint;

    var longitude = $("#address_question_address_question_option_attributes_longitude").val();
    if(!longitude) {
      longitude = $("#map").data("longitude");
      $("#address_question_address_question_option_attributes_longitude").val(longitude);
    }

    var latitude = $("#address_question_address_question_option_attributes_latitude").val();
    if(!latitude) {
      latitude = $("#map").data("latitude");
      $("#address_question_address_question_option_attributes_latitude").val(latitude);
    }

    var distance = $("#address_question_address_question_option_attributes_distance").val();
    distance = distance || defaultDistance;

    map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/harryw/cioz0jzv4000kavm7ndil75zx',
      center: [longitude, latitude],
      zoom: 8
    });

    var canvas = map.getCanvasContainer();

    var geojson = {
      "type": "FeatureCollection",
      "features": [{
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [longitude, latitude]
        }
      }]
    }

    function milesToPixelsAtMaxZoom(miles, latitude) {
      var milesPerPixel = 0.00004660282;
      return miles / milesPerPixel / Math.cos(latitude * Math.PI / 180);
    }

    function mouseDown() {
      if (!isCursorOverPoint) return;

      isDragging = true;

      // Set a cursor indicator
      canvas.style.cursor = 'grab';

      // Mouse events
      map.on('mousemove', onMove);
      map.on('mouseup', onUp);
    }

    function touchStart(e) {
      e.originalEvent.preventDefault();
      var features = map.queryRenderedFeatures(e.point, { layers: ['point'] });

      // Change point and cursor style as a UI indicator
      // and set a flag to enable other mouse events.
      if (features.length) {
        map.setPaintProperty('point', 'circle-color', '#3bb2d0');
        isCursorOverPoint = true;
        map.dragPan.disable();
        isDragging = true;

        map.on('touchmove', onMove);
        map.on('touchend', onTouchEnd);
      } else {
        map.setPaintProperty('point', 'circle-color', '#3887be');
        isCursorOverPoint = false;
        map.dragPan.enable();
      }
    }

    function onMove(e) {
      if (!isDragging) return;

      var coords = e.lngLat;
      // Set a UI indicator for dragging.
      canvas.style.cursor = 'grabbing';

      // Update the Point feature in `geojson` coordinates
      // and call setData to the source layer `point` on it.
      geojson.features[0].geometry.coordinates = [coords.lng, coords.lat];
      map.getSource('point').setData(geojson);
    }

    function onTouchEnd(e) {
      if (!isDragging) return;

      var coords = geojson.features[0].geometry.coordinates;
      $("#address_question_address_question_option_attributes_longitude").val(coords[0]);
      $("#address_question_address_question_option_attributes_latitude").val(coords[1]);
      canvas.style.cursor = '';
      isDragging = false;
      map.setPaintProperty('point', 'circle-color', '#3887be');
      isCursorOverPoint = false;
      map.dragPan.enable();
      map.off('touchmove', onMove);
    }

    function onUp(e) {
      if (!isDragging) return;

      var coords = e.lngLat;
      $("#address_question_address_question_option_attributes_longitude").val(coords.lng);
      $("#address_question_address_question_option_attributes_latitude").val(coords.lat);
      canvas.style.cursor = '';
      isDragging = false;
      map.off('mousemove', onMove);
    }

    map.on('load', function() {

      // Add a single point to the map
      map.addSource('point', {
        "type": "geojson",
        "data": geojson
      });

      map.addLayer({
        "id": "point",
        "type": "circle",
        "source": "point",
        "paint": {
          "circle-opacity": 0.3,
          "circle-radius": {
            "stops": [
              [0, 0],
              [20, milesToPixelsAtMaxZoom(distance, latitude)]
            ],
            "base": 2
          },
          "circle-color": "#3887be"
        }
      });

      $(document).on("input", "#address_question_address_question_option_attributes_distance", function() {
        map.setPaintProperty('point', 'circle-radius', {
          "stops": [
            [0, 0],
            [20, milesToPixelsAtMaxZoom($(this).val(), latitude)]
          ],
          "base": 2
        });
      });

      // If a feature is found on map movement,
      // set a flag to permit a mousedown events.
      map.on('mousemove', function (e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['point'] });
        // Change point and cursor style as a UI indicator
        // and set a flag to enable other mouse events.
        if (features.length) {
          map.setPaintProperty('point', 'circle-color', '#3bb2d0');
          canvas.style.cursor = 'move';
          isCursorOverPoint = true;
          map.dragPan.disable();
        } else {
          map.setPaintProperty('point', 'circle-color', '#3887be');
          canvas.style.cursor = '';
          isCursorOverPoint = false;
          map.dragPan.enable();
        }
      });

      // Set `true` to dispatch the event before other functions call it. This
      // is necessary for disabling the default map dragging behaviour.
      map.on('mousedown', mouseDown, true);
      map.on('touchstart', touchStart, true);
    });
  }

  function tearDownMap() {
    map.remove();
  }

  if($(".question #address-question-option").length) {
    if($(".question #address-question-option #map").length) {
      initMap();
    }

    if($("#address-question-option .nested-fields").length) {
      $(".add_fields").hide();
    }

    $(document).on('cocoon:before-insert', '#address-question-option', function(e, option) {
      $(".add_fields").hide();
      option.find("#address_question_address_question_option_attributes_distance").val(defaultDistance);
    });

    $(document).on('cocoon:after-insert', '#address-question-option', function(e, option) {
      initMap();
    });

    $(document).on('cocoon:before-remove', '#address-question-option', function(e, option) {
      tearDownMap();
    });

    $(document).on('cocoon:after-remove', '#address-question-option', function(e, option) {
      $(".add_fields").show();
    });
  }
});
