$(document).on("turbolinks:load", function() {
  if($(".maps-candidate #map").length) {
    function initMap(candidates) {
      mapboxgl.accessToken = mapboxgl.accessToken || '<%= ENV.fetch("MAPBOX_PUBLIC_KEY") %>';
      var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/harryw/cioz0jzv4000kavm7ndil75zx',
          center: candidates.features[0].geometry.coordinates,
          zoom: $("#map").data("zoom")
      });

      map.on('load', function() {
        map.addSource("candidate", {
          type: "geojson",
          data: candidates
        });

        map.addLayer({
          "id": "candidate",
          "type": "symbol",
          "source": "candidate",
          "layout": {
            "icon-image": "chirpyhire-marker-15"
          }
        });
      });

      var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
      });

      map.on('mousemove', function(e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ["candidate"] });
        map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

        if (!features.length) {
            popup.remove();
            return;
        }

        var feature = features[0];
        popup.setLngLat(feature.geometry.coordinates)
            .setHTML(feature.properties.description)
            .addTo(map);
      });
    }

    $.get({
      url: "/candidates/" + $("#map").data("id") + ".geojson",
      dataType: "json",
      success: initMap.bind(this)
    });
  }
});
