$(document).on("turbolinks:load", function() {
  if($(".survey").length) {
    if($(".survey-question #map")) {
      mapboxgl.accessToken = mapboxgl.accessToken || '<%= ENV.fetch("MAPBOX_PUBLIC_KEY") %>';
      var isDragging, isCursorOverPoint;
      var longitude = $("#map").data("longitude");
      var latitude = $("#map").data("latitude");
      var distance = $("#map").data("distance");

      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/harryw/cioz0jzv4000kavm7ndil75zx',
        center: [longitude, latitude],
        zoom: 8
      });

      var geojson = {
        "type": "FeatureCollection",
        "features": [{
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [longitude, latitude]
          }
        }]
      }

      function milesToPixelsAtMaxZoom(miles, latitude) {
        var milesPerPixel = 0.00004660282;
        return miles / milesPerPixel / Math.cos(latitude * Math.PI / 180);
      }

      map.on('load', function() {
        // Add a single point to the map
        map.addSource('point', {
          "type": "geojson",
          "data": geojson
        });

        map.addLayer({
          "id": "point",
          "type": "circle",
          "source": "point",
          "paint": {
            "circle-opacity": 0.3,
            "circle-radius": {
              "stops": [
                [0, 0],
                [20, milesToPixelsAtMaxZoom(distance, latitude)]
              ],
              "base": 2
            },
            "circle-color": "#3887be"
          }
        });
      });
    };
  };
});
